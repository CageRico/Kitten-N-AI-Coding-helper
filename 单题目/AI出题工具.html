<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KittenN-AI出题助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <h1 class="text-3xl font-bold text-center mb-8 text-blue-600">
            <i class="fa fa-cube"></i> KittenN-AI出题助手
        </h1>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- 左侧：输入区 -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">
                    <i class="fa fa-edit"></i> 出题需求
                </h2>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">选择模型</label>
                        <div class="grid grid-cols-2 gap-3">
                            <div onclick="selectModel('claude')" id="card-claude" class="model-card border-2 border-blue-500 bg-blue-50 rounded-lg p-3 cursor-pointer hover:shadow-md transition">
                                <div class="font-semibold text-blue-700">Claude</div>
                                <div class="text-xs text-gray-600 mt-1">Anthropic官方</div>
                            </div>
                            <div onclick="selectModel('deepseek')" id="card-deepseek" class="model-card border-2 border-gray-300 rounded-lg p-3 cursor-pointer hover:shadow-md transition">
                                <div class="font-semibold text-gray-700">DeepSeek</div>
                                <div class="text-xs text-gray-600 mt-1">深度求索</div>
                            </div>
                            <div onclick="selectModel('qwen')" id="card-qwen" class="model-card border-2 border-gray-300 rounded-lg p-3 cursor-pointer hover:shadow-md transition">
                                <div class="font-semibold text-gray-700">Qwen</div>
                                <div class="text-xs text-gray-600 mt-1">阿里通义千问</div>
                            </div>
                            <div onclick="selectModel('kimi')" id="card-kimi" class="model-card border-2 border-gray-300 rounded-lg p-3 cursor-pointer hover:shadow-md transition">
                                <div class="font-semibold text-gray-700">Kimi</div>
                                <div class="text-xs text-gray-600 mt-1">月之暗面</div>
                            </div>
                            <div onclick="selectModel('modelscope')" id="card-modelscope" class="model-card border-2 border-gray-300 rounded-lg p-3 cursor-pointer hover:shadow-md transition">
                                <div class="font-semibold text-gray-700">ModelScope</div>
                                <div class="text-xs text-gray-600 mt-1">魔搭社区</div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">主题描述</label>
                        <textarea id="topic" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="例如：出一道关于循环的填空题，考察有限循环和变量递增"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">难度</label>
                        <select id="difficulty" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                            <option value="简单">简单</option>
                            <option value="中等" selected>中等</option>
                            <option value="拔高">拔高</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">题型</label>
                        <select id="questionType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                            <option value="填空题" selected>填空题</option>
                            <option value="单选题">单选题</option>
                            <option value="多选题">多选题</option>
                            <option value="问答题">问答题</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Base URL</label>
                        <input type="text" id="baseUrl" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" placeholder="API服务地址">
                        <p class="text-xs text-gray-500 mt-1">根据所选模型自动填充</p>
                    </div>

                    <div id="modelNameDiv" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">模型名称</label>
                        <input type="text" id="modelName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" placeholder="如：deepseek-chat">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
                        <input type="password" id="apiKey" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" placeholder="输入API Key">
                        <p class="text-xs text-gray-500 mt-1">会保存在本地浏览器</p>
                    </div>

                    <button onclick="generateQuestion()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-md transition duration-200">
                        <i class="fa fa-magic"></i> 生成题目
                    </button>
                </div>
            </div>

            <!-- 右侧：输出区 -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">
                    <i class="fa fa-file-text"></i> 生成结果
                </h2>

                <div id="loading" class="hidden text-center py-12">
                    <i class="fa fa-spinner fa-spin text-4xl text-blue-600"></i>
                    <p class="mt-4 text-gray-600">AI正在生成题目...</p>
                </div>

                <div id="result" class="hidden space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">题干</label>
                        <div id="stem" class="p-3 bg-gray-50 rounded border border-gray-200"></div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">积木代码</label>
                        <div class="relative">
                            <pre id="codeBlock" class="p-3 bg-gray-900 text-green-400 rounded text-sm overflow-x-auto"></pre>
                            <button onclick="copyCode()" class="absolute top-2 right-2 bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded text-xs">
                                <i class="fa fa-copy"></i> 复制
                            </button>
                        </div>
                    </div>

                    <div id="optionsDiv" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">选项</label>
                        <div id="options" class="p-3 bg-gray-50 rounded border border-gray-200"></div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">答案</label>
                        <div id="answer" class="p-3 bg-green-50 rounded border border-green-200 text-green-800"></div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">解析</label>
                        <div id="analysis" class="p-3 bg-blue-50 rounded border border-blue-200 text-gray-700"></div>
                    </div>

                    <button onclick="exportJSON()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md transition duration-200">
                        <i class="fa fa-download"></i> 导出JSON
                    </button>
                </div>

                <div id="error" class="hidden p-4 bg-red-50 border border-red-200 rounded text-red-700"></div>
            </div>
        </div>
    </div>

    <script>
        let currentQuestion = null;
        let selectedModel = 'claude';

        // 趣味场景库
        const scenarioPool = [
            "小猫在森林迷宫中寻找宝藏，每找到一个线索就前进几步",
            "编程猫收集星星，不同颜色的星星分数不同",
            "机器人在仓库搬运货物，需要记录搬运次数和总重量",
            "小鸟在天空飞行，遇到云朵会改变飞行高度",
            "智能台灯根据时间自动调节亮度，早中晚亮度不同",
            "自动浇花系统检测土壤湿度，低于阈值就浇水",
            "图书管理员整理书架，按编号顺序排列图书",
            "小明玩跳格子游戏，每次跳的格数按规律变化",
            "糖果工厂生产糖果，每批数量递增，记录总产量",
            "太空飞船躲避陨石，每躲过一次速度加快",
            "画笔机器人绘制螺旋图案，每圈半径增加",
            "音乐盒播放音符，按照特定节奏重复",
            "交通信号灯按时间切换红黄绿，循环控制",
            "小猴子爬树摘香蕉，每层高度不同，记录爬升总高度",
            "魔法师施展法术，每次消耗魔法值，魔法值不足就停止",
            "赛车在跑道上奔跑，每圈速度递增，记录总圈数",
            "农场主收割庄稼，不同作物收益不同，计算总收入",
            "探险家在洞穴探险，火把燃烧时间有限，需要及时补充",
            "小鱼在水中游动，遇到障碍物就转向",
            "程序猫玩猜数字游戏，根据提示调整猜测范围"
        ];

        // JSON提取函数
        function extractJSON(text) {
            text = text.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
            try {
                return JSON.parse(text);
            } catch (e) {}

            let start = text.indexOf('{');
            if (start === -1) return null;

            let depth = 0, inString = false, escape = false;
            for (let i = start; i < text.length; i++) {
                const char = text[i];
                if (escape) { escape = false; continue; }
                if (char === '\\') { escape = true; continue; }
                if (char === '"') { inString = !inString; continue; }
                if (inString) continue;
                if (char === '{') depth++;
                if (char === '}') {
                    depth--;
                    if (depth === 0) {
                        try { return JSON.parse(text.substring(start, i + 1)); } catch (e) {}
                    }
                }
            }
            return null;
        }

        // 语法验证函数
        function validateSyntax(code) {
            const errors = [];

            // 严格的积木语法规则
            const validBlocks = [
                '当开始运行', '当触发事件', '当滑动屏幕', '当键盘触发', '当碰撞发生', '当条件满足时触发', '当收到广播', '发送广播', '判断是否收到广播', '停止脚本', '重启',
                '设置x坐标', '改变x坐标', '设置y坐标', '改变y坐标', '移动步数', '移到位置', '逐渐移动', '移到', '旋转角度', '设置面向角度', '面向对象', '设置旋转模式', '设置碰到边缘反弹', '设置角色拖动', '围绕角色旋转', '逐渐改变x坐标', '逐渐改变y坐标',
                '永远循环', '重复循环', '遍历循环', '重复直到', '退出循环', 'if', 'else', '等待秒数', '等待直到', '打印',
                '落笔', '抬笔', '清除画笔', '设置画笔粗细', '改变画笔粗细', '设置画笔颜色', '移动画笔图层',
                '播放声音', '停止声音', '播放文本', '播放文本直到结束',
                '判断角色碰撞', '判断颜色碰撞', '判断离开边缘', '侦测触发值', '侦测键盘值',
                '随机整数', '舍入运算', '余数运算', '整除判断', '数值判断', '三角函数', '科学计算', '连接字符串', '选择字符串', '字符串长度', '字符串包含判断', '分开字符串', '类型转换',
                '改变变量', '添加列表项', '插入列表项', '删除列表项', '替换列表项', '复制列表项', '列表值', '列表长度', '查找列表值首次位置', '判断列表值是否存在', '获取列表项',
                '设置造型', '切换造型', '设置角色状态', '逐渐改变角色状态', '设置角色大小', '改变角色大小', '设置角色宽高', '改变角色宽高',
                '设置强调特效', '设置入场特效', '设置全局特效',
                '弹出对话框', '弹出提示', '弹出提示指定秒数', '关闭提示', '弹出输入框', '弹出选择框'
            ];

            // 检查是否使用了非法的积木名称或语法
            const lines = code.split('\n');
            for (let line of lines) {
                line = line.trim();
                if (!line || line.startsWith('//')) continue;

                // 检查非法关键词
                if (line.includes('重复执行')) {
                    errors.push('错误：使用了"重复执行"，正确语法是"重复循环"');
                }
                if (line.includes('跳出循环')) {
                    errors.push('错误：使用了"跳出循环"，正确语法是"退出循环"');
                }

                // 检查变量赋值语法（在循环或条件内部不允许直接赋值非初始化的变量）
                // 匹配类似 变量_xxx = 数字; 的模式（但排除初始化场景）
                const varAssignPattern = /(变量_\w+|角色变量_\w+)\s*=\s*\d+\s*;/g;
                const matches = line.match(varAssignPattern);
                if (matches) {
                    // 检查是否在循环或条件内部（简单检测：看前面是否有 => { 或 } 等）
                    const codeBeforeLine = code.substring(0, code.indexOf(line));
                    const openBraces = (codeBeforeLine.match(/\{/g) || []).length;
                    const closeBraces = (codeBeforeLine.match(/\}/g) || []).length;

                    // 如果在嵌套块内（不是顶层初始化），则可能是错误
                    if (openBraces > closeBraces + 1) {
                        errors.push('错误：在循环或条件内部改变变量值，应使用"改变变量"函数，而不是直接赋值');
                    }
                }
            }

            return errors;
        }

        const modelConfigs = {
            claude: {
                baseUrl: 'http://1.95.142.151:3000',
                model: 'claude-sonnet-4-5-20250929-thinking',
                needModelName: false
            },
            deepseek: {
                baseUrl: 'https://api.deepseek.com',
                model: 'deepseek-chat',
                needModelName: true
            },
            qwen: {
                baseUrl: 'https://dashscope.aliyuncs.com/compatible-mode',
                model: 'qwen-plus',
                needModelName: true
            },
            kimi: {
                baseUrl: 'https://api.moonshot.cn/v1',
                model: 'moonshot-v1-8k',
                needModelName: false
            },
            modelscope: {
                baseUrl: 'https://api-inference.modelscope.cn/v1',
                model: 'Qwen/Qwen3-Coder-480B-A35B-Instruct',
                needModelName: true
            }
        };

        function selectModel(model) {
            selectedModel = model;
            const config = modelConfigs[model];

            // 更新卡片样式
            document.querySelectorAll('.model-card').forEach(card => {
                card.classList.remove('border-blue-500', 'bg-blue-50');
                card.classList.add('border-gray-300');
                card.querySelector('div').classList.remove('text-blue-700');
                card.querySelector('div').classList.add('text-gray-700');
            });

            const selectedCard = document.getElementById(`card-${model}`);
            selectedCard.classList.remove('border-gray-300');
            selectedCard.classList.add('border-blue-500', 'bg-blue-50');
            selectedCard.querySelector('div').classList.remove('text-gray-700');
            selectedCard.querySelector('div').classList.add('text-blue-700');

            // 更新配置
            document.getElementById('baseUrl').value = config.baseUrl;
            document.getElementById('modelName').value = config.model;

            // 显示/隐藏模型名称输入框
            if (config.needModelName) {
                document.getElementById('modelNameDiv').classList.remove('hidden');
            } else {
                document.getElementById('modelNameDiv').classList.add('hidden');
            }

            // 保存选择
            localStorage.setItem('selectedModel', model);
        }

        // 加载保存的配置
        window.onload = () => {
            const savedModel = localStorage.getItem('selectedModel') || 'claude';
            const savedKey = localStorage.getItem('apiKey');
            const savedUrl = localStorage.getItem('baseUrl');
            const savedModelName = localStorage.getItem('modelName');

            selectModel(savedModel);

            if (savedKey) document.getElementById('apiKey').value = savedKey;
            if (savedUrl) document.getElementById('baseUrl').value = savedUrl;
            if (savedModelName) document.getElementById('modelName').value = savedModelName;
        };

        async function generateQuestion() {
            const topic = document.getElementById('topic').value.trim();
            const difficulty = document.getElementById('difficulty').value;
            const questionType = document.getElementById('questionType').value;
            const apiKey = document.getElementById('apiKey').value.trim();
            const baseUrl = document.getElementById('baseUrl').value.trim();
            const modelName = document.getElementById('modelName').value.trim();

            if (!topic) {
                showError('请输入主题描述');
                return;
            }

            if (!apiKey) {
                showError('请输入API Key');
                return;
            }

            if (!baseUrl) {
                showError('请输入Base URL');
                return;
            }

            if (modelConfigs[selectedModel].needModelName && !modelName) {
                showError('请输入模型名称');
                return;
            }

            localStorage.setItem('apiKey', apiKey);
            localStorage.setItem('baseUrl', baseUrl);
            localStorage.setItem('modelName', modelName);

            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('result').classList.add('hidden');
            document.getElementById('error').classList.add('hidden');

            try {
                let response;

                // 统一走OpenAI兼容格式（兼容中转服务）
                response = await fetch(`${baseUrl}/v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: modelName || modelConfigs[selectedModel].model,
                        messages: [{
                            role: 'user',
                            content: buildPrompt(topic, difficulty, questionType)
                        }],
                        max_tokens: 4096,
                        temperature: 0.9
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || `HTTP ${response.status}`);
                }

                const data = await response.json();
                let content = data.choices?.[0]?.message?.content || '';

                // 提取并解析JSON
                let questionData = extractJSON(content);
                if (!questionData) throw new Error('无法解析返回结果，未找到有效JSON格式');

                // 语法验证（仅警告，不阻断）
                const syntaxErrors = validateSyntax(questionData.content?.code_block || '');
                if (syntaxErrors.length > 0) {
                    console.warn('发现语法错误:', syntaxErrors);
                }

                currentQuestion = questionData;
                displayResult(currentQuestion);

            } catch (error) {
                showError('生成失败: ' + error.message);
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        // 清洗输出中的chat痕迹
        function cleanQuestionOutput(q) {
            const chatPatterns = /(?:等等|不对|让我(?:重新|再)|我(?:需要|觉得|发现)|嗯|哦|wait|let me)[^。.]*[。.;；]?\s*/gi;
            if (q.answer) q.answer = q.answer.replace(chatPatterns, '').trim();
            if (q.analysis) q.analysis = q.analysis.replace(chatPatterns, '').trim();
            return q;
        }

        function buildPrompt(topic, difficulty, questionType) {
            // 随机选择3个场景作为灵感
            const shuffled = scenarioPool.sort(() => 0.5 - Math.random());
            const selectedScenarios = shuffled.slice(0, 3);

            return `你是专业的少儿编程出题专家。这是一套小众的积木编程语言，语法规则极其严格，任何偏差都会导致编译失败。

# ⚠️ 严格警告
1. 这是小众语言，每个积木的名称、参数、括号、分号都是强制规则
2. 不允许自创积木名称，必须从下方规则库中选择
3. 不允许修改积木语法，哪怕一个字符都不行
4. 错误示例：❌"重复执行"、❌"跳出循环"、❌"变量_flag = 1;"（在循环内） → 正确：✅"重复循环"、✅"退出循环"、✅"改变变量(\"变量_flag\", \"增加\", 1);"
5. 每句代码必须以分号结尾（除了花括号内的最后一句）
6. 变量赋值规则：初始化用"变量_x = n;"，循环/条件内改变用"改变变量(\"变量_x\", \"增加|减少\", n);"

# 出题任务
- 主题：${topic}
- 难度：${difficulty}
- 题型：${questionType}

# 创意要求（重要）
1. ⚠️ 禁止直接模仿下方案例库的题目结构和场景
2. 必须设计有故事性的题干，不要只是"运行脚本，结果是多少"
3. 变量名要有意义（如：变量_分数、变量_高度），不要用a、b、sum
4. 题目要有趣味性，贴近儿童生活
5. 可以参考但不限于以下场景灵感：
   - ${selectedScenarios[0]}
   - ${selectedScenarios[1]}
   - ${selectedScenarios[2]}

# 出题步骤
1. 分析主题，确定需要使用的积木分类
2. 从规则库中精确复制积木语法（不允许修改）
3. 组合积木生成代码
4. 自我检查：每个积木名称是否在规则库中存在
5. **必须逐步模拟执行代码**：像计算机一样逐行执行，跟踪每个变量、列表、坐标的值变化，得出最终结果
6. 确认模拟执行的结果与答案一致后，再输出

# ⚠️ 输出纪律（极其重要）
- **只输出纯JSON**，不要输出任何思考过程、推理过程、自我纠正的文字
- 禁止出现"让我重新计算"、"等等"、"不对"、"我需要修正"等chat风格的语言
- 禁止在JSON外输出任何额外文字
- answer字段只写最终确认的正确答案，analysis字段只写面向学生的标准解析
- 如果你在思考过程中发现答案有误，在内部修正后只输出最终正确版本

# 完整积木语法规范（必须100%遵守）

## 1. Events事件
当开始运行(() => {});
当触发事件("点击|按下|放开", "自己|屏幕|角色名", () => {});
当滑动屏幕("向上|向下|向左|向右", () => {});
当键盘触发("按下|放开", "按键", () => {});
当碰撞发生("开始|持续|结束", "角色名", 角色属性 => {});
当条件满足时触发(条件, () => {});
当收到广播("广播名", () => {});
发送广播("广播名");
判断是否收到广播("广播名");
停止脚本("全部脚本|当前脚本|当前角色的其他脚本|其他角色的脚本");
重启();

## 2. Motions动作
移动步数(n);
移到("鼠标|随机|角色名");
移到位置(x, y);
设置碰到边缘反弹();
设置x坐标(n);
设置y坐标(n);
改变x坐标("增加|减少", n);
改变y坐标("增加|减少", n);
逐渐移动(t, x, y);
逐渐改变x坐标(t, "增加|减少", n);
逐渐改变y坐标(t, "增加|减少", n);
旋转角度(r);
围绕角色旋转("角色名", r);
设置旋转模式("自由旋转|左右翻转|不旋转");
设置面向角度("角度");
面向对象("鼠标|随机|角色名");
设置角色拖动("可拖动|不可拖动");

## 3. Control控制（⚠️ 最容易出错）
永远循环(() => {});
重复循环(n, () => {});  // ⚠️ 不是"重复执行"
遍历循环(起点, 终点, 当前值, i => {});
重复直到(条件, () => {});
退出循环();  // ⚠️ 不是"跳出循环"
if (条件) {}
if (条件) {} else {}
if (条件) {} else if (条件) {} else
等待秒数(t);
等待直到(条件);
打印("文本");

## 4. Pen画笔
落笔();
抬笔();
清除画笔();
设置画笔粗细("n");
改变画笔粗细("增加|减少", n);
设置画笔颜色("色号");
移动画笔图层("最上层|最下层|上一层|下一层");

## 5. Sound声音
播放声音("音频名");
停止声音("全部声音|音频名");
播放文本("文本");
播放文本直到结束("文本");

## 6. Sensing侦测（返回Bool）
判断角色碰撞("角色A", "角色B");
判断颜色碰撞("角色", "色号");
判断离开边缘("边缘|上边缘|下边缘|左边缘|右边缘");
侦测触发值("点击|按下|松开", "屏幕|自己|角色名");
侦测键盘值("点击|按下|松开", "按键");

## 7. Operation运算
// 基础运算
x1 + x2; x1 - x2; x1 * x2; x1 / x2; x1 ^ x2;
随机整数(x1, x2);
// 比较（返回Bool）
x1 === x2; x1 !== x2; x1 > x2; x1 < x2; x1 >= x2; x1 <= x2;
// 逻辑（返回Bool）
条件1 && 条件2; 条件1 || 条件2; ! 条件;
// 数学
舍入运算("四舍五入|向上舍入|向下舍入", n);
余数运算(被除数, 除数);
整除判断(被除数, 除数);
数值判断(n, "质数|整数|合数|奇数|偶数|正数|负数");
三角函数("sin|cos|tan|asin|acos|atan", 角度);
科学计算("算术平方根|绝对值|-|ln|log10|e^|10^", n);
// 字符串
连接字符串("str1", "str2");
选择字符串("str", 起始索引, 结束索引);
字符串长度("str");
字符串包含判断("str", "子串");
分开字符串("str", "分隔符");
类型转换(值, "字符串|数值|布尔");

## 8. Variable变量（⚠️ 赋值规则严格）
// 初始化赋值（仅在顶层或函数开始时使用）
变量_名字 = n;
角色变量_名字 = n;
// 改变变量值（在循环、条件内部必须使用此函数）
改变变量("变量_名字", "增加|减少", n);
改变变量("角色变量_名字", "增加|减少", n);
// 引用变量
变量_名字;
角色变量_名字;

⚠️ 重要规则：
1. 在循环、条件内部改变变量，必须用"改变变量"函数
2. 不允许在循环/条件内直接写：变量_flag = 1;（错误）
3. 正确写法：改变变量("变量_flag", "增加", 1); 或重新初始化

## 9. List列表
添加列表项(值, "列表_名字");
插入列表项(值, "列表_名字", 位置);
删除列表项("列表_名字", "第", 位置);
删除列表项("列表_名字", "最后一项");
删除列表项("列表_名字", "所有项");
替换列表项("列表_名字", "第", 位置, 新值);
替换列表项("列表_名字", "最后一项", 新值);
复制列表项("列表_源", "列表_目标");
列表值("列表_名字", "第", 位置);
列表值("列表_名字", "最后一项");
列表长度("列表_名字");
查找列表值首次位置("列表_名字", 值);
判断列表值是否存在("列表_名字", 值);
获取列表项("列表_名字");

## 10. Looks外观
设置造型(n);
切换造型("下一个|上一个");
设置角色状态("显示|隐藏");
逐渐改变角色状态(t, "逐渐显示|逐渐隐藏");
设置角色大小(n);
改变角色大小("增加|减少", n);
设置角色宽高("高度|宽度", n);
改变角色宽高("高度|宽度", "增加|减少", n);

## 11. Effects特效
设置强调特效("抖动|缩放|跳跃");
设置入场特效("出现|消失", "从上|从下|从左|从右", "掉落|飞入|弹入");
设置全局特效("礼炮|烟花|尴尬|无语");

## 12. Interface界面
弹出对话框("自己|角色名", "内容");
弹出提示("对话|思考", "内容");
弹出提示指定秒数("对话|思考", "内容", t);
关闭提示();
弹出输入框("内容");
弹出选择框("问题", "选项1", "选项2");

# 案例库（学习出题模式）

## 填空题案例1：循环+变量
{
  "topic": "循环逻辑",
  "difficulty": "中等",
  "question_type": "填空题",
  "content": {
    "stem": "运行下列脚本，角色最终的Y坐标位置是_______。",
    "code_block": "当开始运行(() => {设置x坐标(12);设置y坐标(8);重复直到(角色坐标(\\"自己\\", \\"x坐标\\") === 角色坐标(\\"自己\\", \\"x坐标\\"), () => {改变x坐标(\\"增加\\", 1);改变y坐标(\\"增加\\", 2);});});"
  },
  "answer": "正确答案：16",
  "analysis": "角色X轴、Y轴初始坐标值为12、8，X轴比Y轴大4，循环过程中，每次X轴增加1，Y轴增加2，终止条件是X坐标等于Y坐标，所以只要循环4次，就能满足条件，Y轴坐标为：8+2*4=16。"
}

## 填空题案例2：列表操作
{
  "topic": "列表数学类型",
  "difficulty": "中等",
  "question_type": "填空题",
  "content": {
    "stem": "角色脚本如下，运行脚本，最后列表L的第2项是________。",
    "code_block": "当开始运行(() => {变量_a = \\"hello\\";变量_b = \\"good\\";添加列表项(字符串长度(变量_a), \\"列表_L\\");添加列表项(变量_b, \\"列表_L\\");插入列表项(2, \\"列表_L\\", 1);});"
  },
  "answer": "正确答案：5",
  "analysis": "变量a的长度为5，第1次添加时，列表L为：5，第2次添加时，列表L为：5、good，再插入2到第1项，列表L为：2、5、good，所以对话输出的第2项为5。"
}

## 填空题案例3：字符串+循环
{
  "topic": "循环&字符串",
  "difficulty": "拔高",
  "question_type": "填空题",
  "content": {
    "stem": "运行以下脚本后，n值是（   ）。",
    "code_block": "当开始运行(() => {变量_n = 10;变量_文字 = \\"大家都是编程小能手\\";重复直到(选择字符串(变量_文字, 变量_n, 1) === \\"是\\", () => {改变变量(\\"变量_n\\", \\"减少\\", 1);});});"
  },
  "answer": "正确答案：4",
  "analysis": "n其实是索引，当索引值不匹配\\"是\\"则继续减少变量n的值，直到n的索引对应值为\\"是\\"，本质是返回\\"是\\"的索引，索引从1开始。"
}

## 选择题案例1：坐标+循环
{
  "topic": "坐标",
  "difficulty": "简单",
  "question_type": "单选题",
  "content": {
    "stem": "运行下列脚本后，角色最终会停留在哪个坐标附近？A.(200,200) B.(50,200) C.(0,0) D.(50,50)",
    "code_block": "当开始运行(() => {移到位置(0, 0);重复循环(4, () => {设置x坐标(50);改变y坐标(\\"增加\\", 50);});});"
  },
  "answer": "正确答案：B",
  "analysis": "角色初始坐标为（0，0），循环过程中，X轴坐标设置为50不变，Y轴坐标每次增加50，重复执行4次，共增加200，所以最终的坐标为（50，200）"
}

## 选择题案例2：列表插入
{
  "topic": "列表插入",
  "difficulty": "中等",
  "question_type": "单选题",
  "content": {
    "stem": "运行下列脚本后，列表\\"数字\\"将变成（）？A.[1,5,2,4,3] B.[5,4,3,2,1] C.[1,2,3,4,5] D.[4,3,2,1]",
    "code_block": "当开始运行(() => {删除列表项(\\"列表_数字\\", \\"所有项\\");变量_n = 5;重复循环(5, () => {插入列表项(变量_n, \\"列表_数字\\", 6 - 变量_n);改变变量(\\"变量_n\\", \\"减少\\", 1);});});"
  },
  "answer": "正确答案：B",
  "analysis": "列表\\"数字\\"为空列表，变量n初始值为5，先将5插入第1项，然后变量n变为4，再将4插入第2项，以此类推，共插入5项，依次为：5、4、3、2、1。"
}

# 语法细节（严格遵守）
1. 每条语句以分号;结尾
2. 字符串用双引号""，数字不用引号
3. 回调函数：() => {} 或 i => {}
4. 变量名：变量_名字 或 角色变量_名字
5. 列表名：列表_名字 或 角色列表_名字
6. 索引从1开始，不是0
7. 条件判断用===和!==，不是==和!=
8. ⚠️ 变量赋值：顶层初始化用"变量_x = n;"，循环/条件内改变必须用"改变变量(\"变量_x\", \"增加|减少\", n);"

# 题型规则
## 填空题
- 题干中用下划线_______或括号（   ）标记填空位置
- 不需要options字段
- 答案格式：正确答案：xxx

## 选择题（单选/多选）
- 选项直接写在题干中，格式：A.选项1 B.选项2 C.选项3 D.选项4
- 不需要单独的options字段
- 答案格式：正确答案：B 或 正确答案：AB

## 问答题
- 题干为开放性问题
- 不需要options字段
- 答案为详细文字说明

# 输出JSON格式
{
  "topic": "知识点",
  "difficulty": "${difficulty}",
  "question_type": "${questionType}",
  "content": {
    "stem": "题干（选择题的选项直接写在题干中）",
    "code_block": "积木代码"
  },
  "answer": "答案",
  "analysis": "解析"
}

注意：所有题型都不需要单独的options字段，选择题的选项直接写在题干中。

只返回JSON，不要其他内容。`;
        }

        function displayResult(question) {
            document.getElementById('stem').textContent = question.content.stem;
            document.getElementById('codeBlock').textContent = question.content.code_block;
            document.getElementById('answer').textContent = question.answer;
            document.getElementById('analysis').textContent = question.analysis;

            // 选择题的选项已经在题干中，不需要单独显示
            document.getElementById('optionsDiv').classList.add('hidden');

            document.getElementById('result').classList.remove('hidden');
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function copyCode() {
            const code = document.getElementById('codeBlock').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('代码已复制到剪贴板！');
            });
        }

        function exportJSON() {
            if (!currentQuestion) return;

            const blob = new Blob([JSON.stringify(currentQuestion, null, 2)], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `题目_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
